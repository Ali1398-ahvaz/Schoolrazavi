<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ÙØ±Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù‡ÙØªÚ¯ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
<style>
body{font-family:'Vazir',sans-serif;background:#f7fbfd;padding:10px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;vertical-align:middle;}
th{background:#0f4c75;color:#fff;}
.filled{background:#c8f7c5;}
input,select{padding:4px;width:100%;margin-bottom:2px;}
.inline{display:flex;gap:4px;justify-content:center;align-items:center;}
.controls{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
button,a{padding:6px 10px;border:none;background:#0f4c75;color:#fff;border-radius:6px;cursor:pointer;text-decoration:none;}
#previewAttachment img, #previewAttachment video, #previewAttachment audio{max-width:120px; max-height:100px; display:block; margin:4px 0;}
</style>
</head>
<body>

<h2>ÙØ±Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙØªÚ¯ÛŒ</h2>
<div>
<label>Ù†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</label>
<input type="text" id="studentName" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ">
<label>Ú©Ù„Ø§Ø³:</label>
<select id="className">
  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„Ø§Ø³</option>
  <option value="7/1">Û·/Û±</option>
  <option value="7/2">Û·/Û²</option>
</select>
<label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÙˆÙ„ÛŒ:</label>
<input type="text" id="parentPhone" placeholder="Ù…Ø«Ù„Ø§Ù‹ 0912...">
<label>ØªØ§Ø±ÛŒØ® ØªÚ©Ù…ÛŒÙ„ ÙØ±Ù…:</label>
<input type="text" id="formDate" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û´Û°Û´/Û°Û·/Û±Û´">
</div>

<div id="summary">Ø®Ù„Ø§ØµÙ‡: Ù‡Ù†ÙˆØ² Ù¾Ø± Ù†Ø´Ø¯Ù‡</div>

<table id="scheduleTable">
  <thead>
    <tr>
      <th>Ø±ÙˆØ²</th>
      <th>ØªØ§Ø±ÛŒØ®</th>
      <th>Ù†ÙˆØ¨Øª 1</th>
      <th>Ù†ÙˆØ¨Øª 2</th>
      <th>Ù†ÙˆØ¨Øª 3</th>
      <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ Ø¬Ø¯ÙˆÙ„</h3>
<table id="previewTable">
  <thead>
    <tr>
      <th>Ø±ÙˆØ²</th>
      <th>ØªØ§Ø±ÛŒØ®</th>
      <th>Ù†ÙˆØ¨Øª 1</th>
      <th>Ù†ÙˆØ¨Øª 2</th>
      <th>Ù†ÙˆØ¨Øª 3</th>
      <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§</h3>
<input type="file" id="attachment" accept="image/*,audio/*,video/*" multiple>
<div id="previewAttachment"></div>

<div class="controls">
<button id="saveLocal">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ</button>
<button id="clearLocal" style="background:#f55;">ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
<button id="exportPdf">ğŸ“„ Ø°Ø®ÛŒØ±Ù‡ PDF</button>
<button id="sendWhatsapp">ğŸ’¬ Ø§Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ù¾ Ù…Ø¯ÛŒØ±</button>
<button id="sendEmail">âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¯ÛŒØ±</button>
<a href="tel:+989367104429" style="background:#2b7da3">ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø¯ÛŒØ±</a>
</div>

<script>
const days=['Ø´Ù†Ø¨Ù‡','ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡'];
const lessons=['','Ø±ÛŒØ§Ø¶ÛŒ','Ø¹Ù„ÙˆÙ…','Ø§Ø¯Ø¨ÛŒØ§Øª','Ø¹Ø±Ø¨ÛŒ','Ù…Ø·Ø§Ù„Ø¹Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ','Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ','Ù…Ø±ÙˆØ±'];
const hours=['','Û·','Û¸','Û¹','Û±Û°','Û±Û±','Û±Û²','Û±Û³','Û±Û´','Û±Ûµ','Û±Û¶','Û±Û·','Û±Û¸','Û±Û¹','Û²Û°','Û²Û±','Û²Û²'];
const tbody=document.querySelector('#scheduleTable tbody');
const previewTbody=document.querySelector('#previewTable tbody');
const summaryEl=document.getElementById('summary');
const attachment=document.getElementById('attachment');
const previewAttachment=document.getElementById('previewAttachment');
const managerPhone='989367104429';
const managerEmail='favasystemyallali@gmail.com';
let attachments=[];

// Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
function createTables(){
  days.forEach((day,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${day}</td>
      <td><input type="text" class="date" name="date_${i}"></td>
      ${[0,1,2].map(n=>`
        <td>
          <select class="lesson" name="lesson_${n}_${i}">${lessons.map(l=>`<option value="${l}">${l||'Ø¯Ø±Ø³'}</option>`).join('')}</select>
          <div class="inline">
            <select class="from" name="from_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'Ø§Ø²'}</option>`).join('')}</select>
            <span>ØªØ§</span>
            <select class="to" name="to_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'ØªØ§'}</option>`).join('')}</select>
          </div>
        </td>`).join('')}
      <td><input type="text" class="note" name="note_${i}"></td>
    `;
    tbody.appendChild(tr);
    const trPreview=document.createElement('tr');
    trPreview.innerHTML=`
      <td>${day}</td>
      <td class="preview-date"></td>
      ${[0,1,2].map(n=>`<td class="preview-lesson${n}"></td>`).join('')}
      <td class="preview-note"></td>
    `;
    previewTbody.appendChild(trPreview);
  });
}

// Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡
function updatePreview(){
  days.forEach((day,i)=>{
    const dateInput=document.querySelector(`[name=date_${i}]`);
    previewTbody.rows[i].querySelector('.preview-date').textContent=dateInput.value;
    previewTbody.rows[i].querySelector('.preview-date').classList.toggle('filled', dateInput.value.trim()!=='');
    for(let n=0;n<3;n++){
      const lesson=document.querySelector(`[name=lesson_${n}_${i}]`);
      const from=document.querySelector(`[name=from_${n}_${i}]`);
      const to=document.querySelector(`[name=to_${n}_${i}]`);
      const cell=previewTbody.rows[i].querySelector(`.preview-lesson${n}`);
      if(lesson.value){ cell.textContent=`${lesson.value} (${from.value} ØªØ§ ${to.value})`; cell.classList.add('filled'); }
      else cell.textContent='', cell.classList.remove('filled');
    }
    const noteInput=document.querySelector(`[name=note_${i}]`);
    const noteCell=previewTbody.rows[i].querySelector('.preview-note');
    noteCell.textContent=noteInput.value;
    noteCell.classList.toggle('filled', noteInput.value.trim()!=='');
  });
  updateSummary();
}

// Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø´Ø¯Ù‡ + Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ
function markAndUpdate(el){
  const cell=el.closest('td');
  if(el.value.trim()!=='') cell.classList.add('filled');
  else cell.classList.remove('filled');
  localStorage.setItem(el.name,el.value);
  updatePreview();
}

// Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ
function loadLocal(){
  document.querySelectorAll('input,select').forEach(el=>{
    if(localStorage.getItem(el.name)) el.value=localStorage.getItem(el.name);
    markAndUpdate(el);
    el.addEventListener('input',()=>markAndUpdate(el));
    el.addEventListener('change',()=>markAndUpdate(el));
  });
  if(localStorage.getItem('attachments')) attachments=JSON.parse(localStorage.getItem('attachments'));
  attachments.forEach(f=>previewAttachmentFile(f));
}

// Ø®Ù„Ø§ØµÙ‡
function updateSummary(){
  let filledCount=0;
  document.querySelectorAll('select').forEach(s=>{if(s.value) filledCount++;});
  summaryEl.textContent=`Ø®Ù„Ø§ØµÙ‡: ${filledCount} Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡`;
}

// ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
function fillJalaliDates(){
  const today=new Date();
  document.querySelectorAll('.date').forEach((input,idx)=>{
    const nextDay=new Date(today.getTime()+idx*86400000);
    const j=jalaali.toJalaali(nextDay);
    input.value=`${j.jy}/${String(j.jm).padStart(2,'0')}/${String(j.jd).padStart(2,'0')}`;
  });
}

// Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
function previewAttachmentFile(f){
  let el;
  if(f.type.startsWith('image')) el=document.createElement('img'), el.src=f.data;
  else if(f.type.startsWith('video')) el=document.createElement('video'), el.src=f.data, el.controls=true;
  else if(f.type.startsWith('audio')) el=document.createElement('audio'), el.src=f.data, el.controls=true;
  previewAttachment.appendChild(el);
}
attachment.addEventListener('change',e=>{
  Array.from(e.target.files).forEach(f=>{
    const reader=new FileReader();
    reader.onload=function(evt){
      attachments.push({name:f.name,type:f.type,data:evt.target.result});
      previewAttachmentFile({name:f.name,type:f.type,data:evt.target.result});
      localStorage.setItem('attachments',JSON.stringify(attachments));
    };
    reader.readAsDataURL(f);
  });
});

// Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
document.getElementById('saveLocal').addEventListener('click',()=>{ alert('Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); });
document.getElementById('clearLocal').addEventListener('click',()=>{
  if(confirm('Ø¢ÛŒØ§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')){ localStorage.clear(); location.reload(); }
});
document.getElementById('exportPdf').addEventListener('click',async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');
  const content=document.getElementById('previewTable');
  const canvas=await html2canvas(content,{scale:2});
  const imgData=canvas.toDataURL('image/png');
  doc.addImage(imgData,'PNG',20,20,555,canvas.height*555/canvas.width);
  // Ø§ÙØ²ÙˆØ¯Ù† ØªØµØ§ÙˆÛŒØ±
  let y=canvas.height*555/canvas.width+40;
  for(let f of attachments){
    if(f.type.startsWith('image')){
      const img = new Image();
      img.src=f.data;
      await new Promise(r=>{img.onload=()=>{doc.addImage(img,'PNG',20,y,200,200*img.height/img.width); y+=210; r();}});      
    } else {
      doc.text(`ÙØ§ÛŒÙ„: ${f.name}`,20,y); y+=20;
    }
  }
  doc.save('study_plan.pdf');
});
document.getElementById('sendWhatsapp').addEventListener('click',()=>{
  let msg=`ÙØ±Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯. Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²: ${document.getElementById('studentName').value||'(Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…)'}\n`;
  msg+=`Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: (Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ø¨Ø¹Ø¯ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡)\n`;
  window.open('https://wa.me/'+managerPhone+'?text='+encodeURIComponent(msg),'_blank');
});
document.getElementById('sendEmail').addEventListener('click',()=>{
 
