<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>فرم برنامه‌ریزی هفتگی — Schoolrazavi</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@latest/dist/css/persian-datepicker.min.css"/>
<style>
:root{
  --primary:#0f4c75;
  --accent:#2b7da3;
  --muted:#f7fbfd;
  --filled-bg:#d6f5d6;
  --empty-bg:#fff;
  --row1:#ffffff;
  --row2:#f3f9fc;
  --text:#143243;
}
*{box-sizing:border-box}
body{font-family:'Vazir',sans-serif;background:var(--muted);color:var(--text);margin:0;padding:14px;direction:rtl}
.container{max-width:980px;margin:10px auto;background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(10,30,40,0.06)}
.header{display:flex;align-items:center;gap:12px;border-bottom:2px solid var(--primary);padding-bottom:10px}
.brand{display:flex;align-items:center;gap:8px}
.brand img{width:44px;height:44px;object-fit:contain;border-radius:6px}
h1{flex:1;font-size:16px;color:var(--primary);margin:0;text-align:center}
.meta{font-size:12px;color:#456}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
label{font-weight:700;font-size:13px}
input,select,textarea{font-family:'Vazir',sans-serif}
input,select,textarea{width:100%;padding:6px;border:1px solid #e1eef6;border-radius:6px;font-size:13px;background:var(--empty-bg)}
.small-input{width:44px;padding:6px 4px;text-align:center;font-size:13px}
.small-select{padding:4px 6px;font-size:12px;border-radius:6px}
.full{grid-column:1/-1}
.table-wrap{overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border:1px solid #e6f0f6;text-align:center;vertical-align:middle}
th{background:var(--primary);color:#fff;font-weight:700}
tbody tr:nth-child(odd){background:var(--row1)}
tbody tr:nth-child(even){background:var(--row2)}
.day-cell{font-weight:800}
.schedule-cell{white-space:nowrap}
.inline{display:inline-flex;align-items:center;gap:6px;justify-content:center}
.controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{background:var(--primary);color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-size:13px}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid #d6eaf4}
.note{font-size:12px;color:#556;margin-top:8px;text-align:left}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:#fff;border-radius:8px;padding:14px;max-width:420px;width:92%}
.modal h3{margin:0 0 8px 0;text-align:right}
.modal .row{display:flex;gap:8px;margin-top:8px}
.modal input{flex:1}
.filled{background:var(--filled-bg) !important}
@media(max-width:820px){.form-grid{grid-template-columns:1fr}th,td{font-size:12px}.small-input{width:38px}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Emblem_of_Iran.svg/120px-Emblem_of_Iran.svg.png" alt="آرم">
      <img src="https://files.virgool.io/upload/users/1605210/posts/n8ihxhpij7op/ku69kkvrogtv.jpg" alt="لوگو">
    </div>
    <h1>فرم برنامه‌ریزی مطالعه هفتگی — Schoolrazavi</h1>
    <div class="meta" id="summary">خلاصه: هنوز پر نشده</div>
  </div>

  <div class="form-grid" role="form">
    <div>
      <label for="studentName">نام دانش‌آموز</label>
      <input id="studentName" name="studentName" placeholder="مثلاً: علی رضایی">
    </div>

    <div>
      <label for="className">کلاس</label>
      <select id="className" name="className">
        <option value="">انتخاب کلاس</option>
        <option value="7/1">۷/۱</option>
        <option value="7/2">۷/۲</option>
      </select>
    </div>

    <div>
      <label for="parentPhone">شماره تماس ولی</label>
      <input id="parentPhone" name="parentPhone" placeholder="مثلاً: 0912...">
    </div>

    <div>
      <label for="formDate">تاریخ تکمیل</label>
      <input id="formDate" name="formDate" placeholder="۱۴۰۴/۰۷/۱۴">
    </div>

    <div class="full table-wrap" aria-live="polite">
      <table aria-label="برنامه هفتگی">
        <thead>
          <tr>
            <th>روز</th>
            <th>نوبت 1</th>
            <th>نوبت 2</th>
            <th>نوبت 3</th>
            <th>توضیحات</th>
          </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>

    <div>
      <label for="attachment">پیوست (صوت/عکس/ویدئو)</label>
      <input type="file" id="attachment" accept="audio/*,image/*,video/*">
    </div>

    <div class="full">
      <div class="controls" role="group" aria-label="دکمه‌های فرم">
        <button class="btn" id="saveLocal">💾 ذخیره</button>
        <button class="btn" id="toPdf">📄 PDF</button>
        <button class="btn" id="whatsappManager">💬 واتساپ مدیر</button>
        <button class="btn" id="sendFriend">💬 ارسال به دوست</button>
        <button class="btn" id="emailBtn">✉️ ایمیل</button>
        <a class="btn btn-ghost" id="callLink" href="tel:00989367104429">📞 تماس</a>
        <button class="btn btn-ghost" id="printBtn" style="background:#fff;color:var(--primary);border:1px solid var(--primary)">🖨 چاپ</button>
        <button class="btn btn-ghost" id="clearBtn" style="background:#f55;color:#fff">🧹 پاک‌سازی</button>
      </div>
      <div class="note">توضیح: ساعت‌ها از ۷ تا ۲۲ انتخابی هستند و فیلدهای پرشده سبز روشن می‌شوند.</div>
    </div>
  </div>
</div>

<!-- modal to ask friend's number -->
<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">ارسال به دوست — شماره را وارد کنید</h3>
    <div>
      <label for="friendNumber">شماره دوست (مثلاً 98912...)</label>
      <input id="friendNumber" placeholder="مثلاً 98912..." inputmode="numeric" pattern="[0-9]*">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="modalSend">ارسال</button>
      <button class="btn btn-ghost" id="modalCancel">انصراف</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@latest/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@latest/dist/js/persian-datepicker.min.js"></script>

<script>
const managerPhone = '989367104429';
const managerEmail = 'favasystemyallali@gmail.com';
const shareLink = 'https://Ali1398-ahvaz.github.io/Schoolrazavi/';
const days = ['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];
const lessons = ['','ریاضی','علوم','ادبیات','عربی','مطالعات اجتماعی','زبان انگلیسی','مرور'];
const hours = ['','۷','۸','۹','۱۰','۱۱','۱۲','۱۳','۱۴','۱۵','۱۶','۱۷','۱۸','۱۹','۲۰','۲۱','۲۲'];

const tbody = document.getElementById('scheduleBody');

// build table rows
days.forEach((day, i)=>{
  const tr = document.createElement('tr');
  tr.innerHTML = `<td class="day-cell">${day}</td>
    ${[0,1,2].map(n=>`<td class="schedule-cell">
      <div class="inline">
        <select class="small-select field-lesson" name="lesson_${n}_${i}">${lessons.map(l=>`<option value="${l}">${l||'درس'}</option>`).join('')}</select>
        <span>از</span>
        <select class="small-select field-from" name="from_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'س'}</option>`).join('')}</select>
        <span>تا</span>
        <select class="small-select field-to" name="to_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'س'}</option>`).join('')}</select>
      </div>
    </td>`).join('')}
    <td><input name="note_${i}" placeholder="توضیحات کوتاه"></td>`;
  tbody.appendChild(tr);
});

// Persian datepicker
$("#formDate").persianDatepicker({
  format: 'YYYY/MM/DD',
  initialValueType: 'persian',
  calendarType: 'persian',
  autoClose: true
});

// helper functions
function keyFor(el){ return 'study_form_'+(el.name||el.id); }
const selector = 'input, select, textarea';

function saveAll(){
  document.querySelectorAll(selector).forEach(el=>{
    try{localStorage.setItem(keyFor(el), el.value||'');}catch(e){}
  });
  updateSummary();
  markFilledFields();
  alert('ذخیره محلی انجام شد.');
}

function loadAll(){
  document.querySelectorAll(selector).forEach(el=>{
    const v = localStorage.getItem(keyFor(el));
    if(v!==null) el.value=v;
  });
  markFilledFields();
  updateSummary();
}

function markFilledFields(){
  document.querySelectorAll(selector).forEach(el=>{
    const parent = el.closest('td');
    if(!parent) return;
    const filled = el.value && el.value.trim() !== '';
    if(filled) parent.classList.add('filled');
    else parent.classList.remove('filled');
  });
}

const summaryEl = document.getElementById('summary');
function generateSummary(){
  const name = document.getElementById('studentName').value || '(بدون نام)';
  const cls = document.getElementById('className').value || '(بدون کلاس)';
  let cnt=0;
  document.querySelectorAll('#scheduleBody select').forEach(s=>{if(s.value) cnt++;});
  return `دانش‌آموز: ${name} — کلاس: ${cls} — انتخاب‌ها: ${cnt}`;
}
function updateSummary(){summaryEl.textContent=generateSummary();}

// events
document.addEventListener('input',e=>{
  if(e.target.matches(selector)){
    try{localStorage.setItem(keyFor(e.target), e.target.value||'');}catch(e){}
    debounceUpdate();
  }
});

let tmr=null;
function debounceUpdate(){if(tmr) clearTimeout(tmr); tmr=setTimeout(()=>{updateSummary(); markFilledFields();},200);}

document.getElementById('saveLocal').addEventListener('click',saveAll);
document.getElementById('clearBtn').addEventListener('click',()=>{
  if(!confirm('پاک شود؟')) return;
  document.querySelectorAll(selector).forEach(el=>el.value='');
  Object.keys(localStorage).forEach(k=>{if(k.startsWith('study_form_')) localStorage.removeItem(k);});
  markFilledFields(); updateSummary();
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());
document.getElementById('toPdf').addEventListener('click',()=>window.print());

// WhatsApp manager
document.getElementById('whatsappManager').addEventListener('click',()=>{
  saveAll();
  const name = encodeURIComponent(document.getElementById('studentName').value||'');
  const cls = encodeURIComponent(document.getElementById('className').value||'');
  let msg=`سلام مدیر، فرم تکمیل شد.%0Aدانش‌آموز: ${name}%0Aکلاس: ${cls}%0A`;
  days.forEach((d,i)=>{
    let parts=[];
    [0,1,2].forEach(n=>{
      const lesson=document.querySelector(`[name="lesson_${n}_${i}"]`).value||'';
      const from=document.querySelector(`[name="from_${n}_${i}"]`).value||'';
      const to=document.querySelector(`[name="to_${n}_${i}"]`).value||'';
      if(lesson && from && to) parts.push(`${lesson} — از ${from} تا ${to}`);
    });
    const note=document.querySelector(`[name="note_${i}"]`).value||'';
    if(parts.length) msg+=`${d}: ${parts.join(' | ')}${note? ' — '+encodeURIComponent(note):''}%0A`;
  });
  window.open(`https://wa.me/${managerPhone}?text=${msg}`,'_blank');
});

// Send to friend modal
const modalBack=document.getElementById('modalBack');
document.getElementById('sendFriend').addEventListener('click',()=>{document.getElementById('friendNumber').value=''; modalBack.style.display='flex';});
document.getElementById('modalCancel').addEventListener('click',()=>modalBack.style.display='none');
document.getElementById('modalSend').addEventListener('click',()=>{
  const raw=document.getElementById('friendNumber').value.trim();
  const digits=raw.replace(/[^0-9]/g,'');
  if(!digits || digits.length<9){alert('شماره صحیح وارد کنید'); return;}
  const waUrl=`https://wa.me/${digits}?text=${encodeURIComponent(shareLink)}`;
  modalBack.style.display='none';
  window.open(waUrl,'_blank');
});

// Email
document.getElementById('emailBtn').addEventListener('click',()=>{
  saveAll();
  const name=encodeURIComponent(document.getElementById('studentName').value||'');
  const cls=encodeURIComponent(document.getElementById('class
