<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>فرم هفتگی با تقویم شمسی</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:'Vazir',sans-serif;padding:10px;background:#f7fbfd;direction:rtl;}
table{border-collapse:collapse;width:100%;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;vertical-align:middle;}
th{background:#0f4c75;color:#fff;}
.filled{background:#c8f7c5;}
input,select{padding:4px;width:100%;margin-bottom:2px;}
.controls{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap;}
button{padding:6px 10px;border:none;background:#0f4c75;color:#fff;border-radius:6px;cursor:pointer;}
.inline{display:flex;gap:4px;justify-content:center;align-items:center;}
</style>
</head>
<body>

<h2>فرم برنامه‌ریزی مطالعه هفتگی — نسخه پیشرفته</h2>
<div id="summary">خلاصه: هنوز پر نشده</div>

<table id="scheduleTable">
  <thead>
    <tr>
      <th>روز</th>
      <th>تاریخ</th>
      <th>نوبت 1</th>
      <th>نوبت 2</th>
      <th>نوبت 3</th>
      <th>توضیحات</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="controls">
<button id="saveLocal">💾 ذخیره</button>
<button id="toPdf">📄 PDF</button>
<button id="whatsapp">💬 واتساپ</button>
<button id="email">✉️ ایمیل</button>
</div>

<script>
const days=['شنبه','یک‌شنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنج‌شنبه','جمعه'];
const lessons=['','ریاضی','علوم','ادبیات','عربی','مطالعات اجتماعی','زبان انگلیسی','مرور'];
const hours=['','۷','۸','۹','۱۰','۱۱','۱۲','۱۳','۱۴','۱۵','۱۶','۱۷','۱۸','۱۹','۲۰','۲۱','۲۲'];
const tbody=document.querySelector('#scheduleTable tbody');
const summaryEl=document.getElementById('summary');
const managerPhone='989367104429';
const managerEmail='favasystemyallali@gmail.com';

// ساخت جدول
days.forEach((day,i)=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${day}</td>
    <td><input type="text" class="date" name="date_${i}"></td>
    ${[0,1,2].map(n=>`
      <td>
        <select class="lesson" name="lesson_${n}_${i}">${lessons.map(l=>`<option value="${l}">${l||'درس'}</option>`).join('')}</select>
        <div class="inline">
          <select class="from" name="from_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'از'}</option>`).join('')}</select>
          <span>تا</span>
          <select class="to" name="to_${n}_${i}">${hours.map(h=>`<option value="${h}">${h||'تا'}</option>`).join('')}</select>
        </div>
      </td>`).join('')}
    <td><input type="text" class="note" name="note_${i}"></td>
  `;
  tbody.appendChild(tr);
});

// تقویم شمسی
$(document).ready(function(){
  $(".date").each(function(){
    $(this).persianDatepicker({
      format: 'YYYY/MM/DD',
      initialValue: true,
      autoClose: true,
      onSelect: function(){
        markAndSave(this);
      }
    });
  });
});

// رنگ سلول و ذخیره محلی
function markAndSave(el){
  const cell=el.closest('td');
  if(el.value.trim()!=='') cell.classList.add('filled');
  else cell.classList.remove('filled');
  localStorage.setItem(el.name,el.value);
  updateSummary();
}

// ادامه خودکار ساعت‌ها
function autoFillNext(fromEl){
  const td=fromEl.closest('td');
  const tr=td.closest('tr');
  const tds=Array.from(tr.querySelectorAll('td')).filter(td=>td.querySelector('select.from'));
  for(let i=0;i<tds.length-1;i++){
    if(tds[i].contains(fromEl)){
      const nextFrom=tds[i+1].querySelector('select.from');
      const nextTo=tds[i+1].querySelector('select.to');
      if(nextFrom.value==='' && fromEl.value!==''){
        nextFrom.value=fromEl.value;
        nextTo.value='';
        markAndSave(nextFrom);
        markAndSave(nextTo);
      }
      break;
    }
  }
}

document.querySelectorAll('input, select').forEach(el=>{
  if(localStorage.getItem(el.name)) el.value=localStorage.getItem(el.name);
  markAndSave(el);
  el.addEventListener('input', ()=>markAndSave(el));
  el.addEventListener('change', ()=>{
    markAndSave(el);
    if(el.classList.contains('to')) autoFillNext(el);
  });
});

// خلاصه فرم
function updateSummary(){
  let filledCount=0;
  document.querySelectorAll('select').forEach(s=>{if(s.value) filledCount++;});
  summaryEl.textContent=`خلاصه: ${filledCount} انتخاب انجام شده`;
}

// ذخیره کل فرم
document.getElementById('saveLocal').addEventListener('click', ()=>{
  document.querySelectorAll('input, select').forEach(el=>localStorage.setItem(el.name,el.value));
  alert('ذخیره شد!');
});

// PDF
document.getElementById('toPdf').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  let text='فرم برنامه‌ریزی مطالعه هفتگی\n\n';
  days.forEach((day,i)=>{
    text+=day+' | '+document.querySelector(`[name=date_${i}]`).value+' | ';
    for(let n=0;n<3;n++){
      text+=document.querySelector(`[name=lesson_${n}_${i}]`).value+' ';
      text+=document.querySelector(`[name=from_${n}_${i}]`).value+' تا ';
      text+=document.querySelector(`[name=to_${n}_${i}]`).value+' | ';
    }
    text+=document.querySelector(`[name=note_${i}]`).value+'\n';
  });
  doc.text(text,10,10);
  doc.save('weekly_schedule.pdf');
});

// واتساپ
document.getElementById('whatsapp').addEventListener('click', ()=>{
  let msg='فرم برنامه‌ریزی تکمیل شد.%0A';
  days.forEach((day,i)=>{
    msg+=day+': ';
    for(let n=0;n<3;n++){
      msg+=document.querySelector(`[name=lesson_${n}_${i}]`).value+' ';
      msg+=document.querySelector(`[name=from_${n}_${i}]`).value+' تا ';
      msg+=document.querySelector(`[name=to_${n}_${i}]`).value+' | ';
    }
    msg+=document.querySelector(`[name=note_${i}]`).value+'%0A';
  });
  window.open(`https://wa.me/${managerPhone}?text=${msg}`,'_blank');
});

// ایمیل
document.getElementById('email').addEventListener('click', ()=>{
  let body='فرم برنامه‌ریزی تکمیل شد.%0A';
  days.forEach((day,i)=>{
    body+=day+': ';
    for(let n=0;n<3;n++){
      body+=document.querySelector(`[name=lesson_${n}_${i}]`).value+' ';
      body+=document.querySelector(`[name=from_${n}_${i}]`).value+' تا ';
      body+=document.querySelector(`[name=to_${n}_${i}]`).value+' | ';
    }
    body+=document.querySelector(`[name=note_${i}]`).value+'%0A';
  });
  window.open(`mailto:${managerEmail}?subject=فرم برنامه‌ریزی&body=${body}`,'_blank');
});
</script>

</body>
</html>
